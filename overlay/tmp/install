#!/bin/sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Install S6 Overlay.
#======================================================================================================================

install () {

    # get file
    FILE=s6-overlay-${1}.tar.xz

    # check integrity
    sha256sum -cs ${FILE}.sha256 \
        || bf-error " .. S6 Overlay download does not match checksum."

    # extract
    bf-echo " .. extracting ${FILE}..."
    tar -C / -Jxpf ${FILE} \
        || bf-error " .. unable to extract ${FILE}."

}

bf-echo "Installing S6 Overlay..."
cd /s6
ARCH=`cat arch`
install "noarch"
install ${ARCH}
bf-done


#======================================================================================================================
# Install zabbix agent for Alpine versions >= 3.11.
#======================================================================================================================

if [ "${ALPINE_MINOR}" -ge "3.11" ] ; then

    bf-echo "Installing Zabbix agent..."
    apk add --no-cache \
        zabbix-agent2
    bf-done

else

    bf-echo "Removing Zabbix agent service definition..."
    bf-rmrf /etc/bf/init.d/04-zabbix
    bf-rmrf /etc/bf/templates/zabbix_agent2.conf.esh
    bf-rmrf /etc/s6-overlay/s6-rc.d/zabbix-agent
    bf-rmrf /etc/s6-overlay/s6-rc.d/user/contents.d/zabbix-agent
    bf-done

fi


#======================================================================================================================
# Add 1min cron directory.
#======================================================================================================================

bf-echo "Adding 1min cron directory..."
mkdir /etc/periodic/1min
bf-done


#======================================================================================================================
# Cleanup.
#======================================================================================================================

bf-echo "Removing installation files..."
rm -rf /s6
bf-done
