#!/bin/sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Ensure target platform is set.
#======================================================================================================================

[[ -z "${TARGETPLATFORM-}" ]] && bf-error "Target platform not set."


#======================================================================================================================
# Get correct installer for target platform.
#======================================================================================================================

case "${TARGETPLATFORM}" in

    linux/amd64)
        ARCH="x86_64"
        ;;

    linux/arm/v7)
        ARCH="arm"
        ;;

    linux/arm64)
        ARCH="aarch64"
        ;;

    *)
        bf-error "Unsupported target platform: ${TARGETPLATFORM}."
        ;;

esac

bf-debug "Platform architecture ${ARCH}."


#======================================================================================================================
# Get S6 Overlay version.
#======================================================================================================================

cd /tmp

S6_VERSION=$(cat S6_VERSION)
bf-debug "S6 Overlay version ${S6_VERSION}."


#======================================================================================================================
# Download and install S6 Overlay.
#======================================================================================================================

FILE="s6-overlay-${ARCH}-${S6_VERSION}.tar.xz"
S6_URL="https://github.com/just-containers/s6-overlay/releases/download/v${S6_VERSION}/${FILE}"
bf-echo "Downloading ${S6_URL}..."
wget ${S6_URL}
bf-done

bf-echo "Checking download integrity..."
wget ${S6_URL}.sha256
sha256sum -cs ${FILE}.sha256 && bf-done \
    || bf-error "S6 Overlay download does not match checksum."

bf-echo "Installing S6 Overlay v${S6_VERSION}..."
tar -C / -Jxpf ./${FILE}

[[ -d /etc/s6 ]] && bf-done \
    || bf-error "S6 Overlay not installed."


#======================================================================================================================
# Create bf directories.
#======================================================================================================================

bf-debug "Creating bf directories."
mkdir /etc/periodic/1min
mkdir -p /etc/bf/src
mkdir -p /etc/bf/templates
mkdir -p /usr/lib/bf/inc
