#!/bin/sh

set -eo pipefail


#======================================================================================================================
# Check for target platform
#======================================================================================================================

[[ -z "${TARGETPLATFORM}" ]] && _error "Target platform not set."


#======================================================================================================================
# Get correct installer for target platform
#======================================================================================================================

case "${TARGETPLATFORM}" in
    "linux/amd64")
        ARCH="amd64"
        ;;
    "linux/arm/v7")
        ARCH="armhf"
        ;;
    "linux/arm64")
        ARCH="aarch64"
        ;;
    *)
esac

[[ -z "${ARCH}" ]] && _error "Unsupported target platform: ${TARGETPLATFORM}."


#======================================================================================================================
# Download and run S6 installer
#======================================================================================================================

cd /tmp

S6_URL="https://github.com/just-containers/s6-overlay/releases/download/v${S6_VERSION}/s6-overlay-${ARCH}-installer"
_echo "Downloading ${S6_URL}..."
wget -O installer ${S6_URL} && chmod +x installer
_done

_echo "Installing S6 v${S6_VERSION}..."
./installer /

[[ -d /etc/s6 ]] && _done || _error "S6 not installed."


#======================================================================================================================
# Download sempl
# See https://github.com/nextrevision/sempl
#======================================================================================================================

SEMPL_URL=https://raw.githubusercontent.com/nextrevision/sempl/master/sempl
_echo "Downloading ${SEMPL_URL}..."
wget -O sempl ${SEMPL_URL} && chmod +x sempl
_done

_echo "Moving sempl to /usr/local/bin..."
mv sempl /usr/local/bin/
TEST=$(/usr/local/bin/sempl -o tmpl)
[[ -n ${TEST} ]] && _done || _error "Mo not installed."


#======================================================================================================================
# Upgrade packages and set timezone
#======================================================================================================================

_echo "Upgrading packages..."
apk -U upgrade
_done

_tz "Europe/London"
