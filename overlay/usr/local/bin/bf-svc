#!/usr/bin/with-contenv sh

set -euo pipefail


#======================================================================================================================
# Check arguments.
#   1   Control action 'disable', 'restart', 'start', 'stop'
#   2   Service name
#======================================================================================================================

[[ -z "${1-}" ]] && bf-error "You must provide the control action." "bf-svc"
ACTION=${1}

[[ -z "${2-}" ]] && bf-error "You must provide the name of a service." "bf-svc"
NAME=${2}


#======================================================================================================================
# Check environment variable.
#======================================================================================================================

[[ -z "${S6_SERVICES-}" ]] && bf-error "S6_SERVICES environment variable is not set." "bf-svc"
SVC=${S6_SERVICES}/${NAME}


#======================================================================================================================
# Control a supervised service.
#======================================================================================================================

[[ ! -d "${SVC}" ]] && bf-error "Service '${NAME}' does not exist." "bf-svc"

case "${ACTION}" in

    disable)
        bf-echo "Disabling service '${NAME}'." "bf-svc"
        s6-svc -d "${SVC}"
        ;;

    restart)
        bf-echo "Restarting service '${NAME}'." "bf-svc"
        s6-svc -r "${SVC}"
        ;;

    start)
        bf-echo "Starting service '${NAME}'." "bf-svc"
        s6-svc -u "${SVC}"
        ;;

    stop)
        bf-echo "Stopping service '${NAME}'." "bf-svc"
        s6-svc -t "${SVC}"
        ;;

    *)
        bf-error "Unknown control action '${ACTION}'." "bf-svc"
        ;;

esac
